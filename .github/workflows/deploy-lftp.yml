name: Deploy to Production (LFTP Method)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

env:
  NODE_VERSION: '18.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build TypeScript
        run: yarn build

      - name: Verify build output
        run: |
          echo "ðŸ” Verifying build output..."
          if [ ! -d "dist" ]; then
            echo "âŒ ERROR: dist folder not found!"
            exit 1
          fi
          JS_COUNT=$(find dist -type f -name "*.js" | wc -l)
          echo "âœ… dist folder exists with $JS_COUNT JS files"
          if [ $JS_COUNT -eq 0 ]; then
            echo "âŒ ERROR: No JS files found in dist!"
            exit 1
          fi
          find dist -type f -name "*.js" | head -10

      - name: Prepare deployment files
        run: |
          echo "ðŸ“¦ Preparing deployment files..."
          
          # Create temp directory
          mkdir -p deploy-temp
          
          # Copy dist with all files
          echo "Copying dist folder..."
          cp -r dist deploy-temp/
          
          # Copy uploads if exists
          if [ -d "uploads" ] && [ "$(ls -A uploads)" ]; then
            echo "Copying uploads folder..."
            cp -r uploads deploy-temp/
          else
            mkdir -p deploy-temp/uploads
          fi
          
          # Copy essential files
          cp package.json deploy-temp/
          cp yarn.lock deploy-temp/
          
          if [ -f ".env" ]; then
            cp .env deploy-temp/
          fi
          
          # Verify
          echo "âœ… Files prepared:"
          echo "  JS files: $(find deploy-temp/dist -name '*.js' 2>/dev/null | wc -l)"
          echo "  Total files: $(find deploy-temp -type f | wc -l)"

      - name: Install LFTP
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Deploy via LFTP
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        run: |
          echo "ðŸš€ Starting FTP deployment with LFTP..."
          
          # Create lftp script
          cat > /tmp/ftp_deploy.lftp << 'LFTPSCRIPT'
          set ftp:ssl-allow no
          set ftp:passive-mode yes
          set ftp:list-options -a
          set ssl:verify-certificate no
          set net:timeout 30
          set net:max-retries 3
          
          open -u $FTP_USER,$FTP_PASS $FTP_HOST
          
          cd /zoomit-backend/
          
          # Upload dist folder with all files
          echo "Uploading dist folder..."
          mirror -R -v --delete --parallel=5 --exclude-glob="*.map" deploy-temp/dist dist
          
          # Upload uploads folder if exists
          if [ -d "deploy-temp/uploads" ] && [ "$(ls -A deploy-temp/uploads)" ]; then
            echo "Uploading uploads folder..."
            mirror -R -v --delete --parallel=5 deploy-temp/uploads uploads
          fi
          
          # Upload individual files
          echo "Uploading package files..."
          put deploy-temp/package.json -o package.json
          put deploy-temp/yarn.lock -o yarn.lock
          
          if [ -f "deploy-temp/.env" ]; then
            put deploy-temp/.env -o .env
          fi
          
          # Verify upload
          echo "Verifying uploaded files..."
          ls -la dist/ | head -10
          echo "Total files in dist:"
          find dist -type f | wc -l
          
          quit
          LFTPSCRIPT
          
          # Execute FTP upload
          lftp -f /tmp/ftp_deploy.lftp
          
          if [ $? -eq 0 ]; then
            echo "âœ… FTP deployment completed successfully!"
          else
            echo "âŒ FTP deployment failed!"
            exit 1
          fi

      - name: Cleanup
        run: rm -rf deploy-temp

      - name: Deployment Success
        run: echo "âœ… All files deployed successfully!"

